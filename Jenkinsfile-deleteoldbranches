import groovy.json.JsonSlurperClassic
import groovy.json.JsonOutput

pipeline {
    agent any
    // triggers {
    //     //Run once a week every Saturday
    // cron('30 0 * * 6')
    // }
    options {
		buildDiscarder(logRotator(numToKeepStr: '100'))
		disableConcurrentBuilds()
		timestamps()
	}
    environment {
        GIT_ORG                 = 'git@github.com:ajaysharma507'
    }
    stages {
        stage ('Git backup'){
            steps {
                script {
                        echo "deleting 6 months old tags"
                        deleteTags('ajaysharma507', 100)
                    }
                }
            }
    }
    //post {
        //failure  {
            //slackSend channel: '#devops-monitor',color: 'bad', tokenCredentialId: 'polar-slack',message: "FAILURE: #${BUILD_NUMBER} build FAILED!\n${RUN_DISPLAY_URL}"
       // }
   // }
}


def deleteTags(organization, limit)  {
    // Set the credentials for authenticating with the GitHub API
    def credentials = [
        username: 'ajaysharma507@gmail.com',
        password: "Employeesupport@5"
    ]

    // Set the URL for the GitHub API
    def apiUrl = 'https://api.github.com'

    // Set the URL for the organization's repositories
    def reposUrl = "${apiUrl}/orgs/${organization}/repos"

    // Set the date
    def sixMonthsAgo = new Date() - 183 // 6 months in days

    // check tag pattersns with Roy/Dan
    def tagNamePattern = "v*" 

    //list tags to delete
    def tagsToDelete = sh(script: "git tag -l '$tagNamePattern'", returnStdout: true).trim().split('\n').findAll {
        def tagDate = sh(script: "git log -n 1 --pretty=format:%ct $it", returnStdout: true).toLong() * 1000
        return tagDate < sixMonthsAgo.getTime()
    }


    // Set the authentication headers
    def authHeaders = [
        "Authorization": "Basic " + "${credentials.username}:${credentials.password}".getBytes().encodeBase64().toString(),
        "Content-Type": "application/json"
    ]

    // Set the parameters for the API request
    def params = [
        "type": "all",
        "per_page": "${limit}",
        //"archived": "false"
    ]

    // Send the API request and store the response
    def response = new URL(reposUrl).getText(requestProperties: authHeaders, query: params)

    // Parse the JSON response and print the names of the repositories
    def json = new groovy.json.JsonSlurperClassic().parseText(response)
    

    json.each { repo ->
        global_prettyPrintWithHeaderAndFooter header: "Looping through git repo", body: "${repo.name}", lineLenght: 20
        def repoUrl = "${GIT_ORG}/${repo.name}.git"
        checkout([$class: 'GitSCM', branches: [[name: 'main']], userRemoteConfigs: [[url: "${repoUrl}", credentialsId:'377f8df0-2d19-450e-a33c-b11da6de3837']]])

        tagsToDelete.each { tagName ->
            sh "git tag -d $tagName"
            sh "git push origin :refs/tags/$tagName"
            echo "Deleted tag: $tagName"
       }
    }
}











